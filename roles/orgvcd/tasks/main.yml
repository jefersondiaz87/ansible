---
# ===========================================================
# VALIDAR SI EL ORG VDC YA EXISTE
# ===========================================================
- name: Verificar si el Org VDC ya existe en VMware Cloud Director
  uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/orgs?filter=name=={{ vcd.orgVdcName }}"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: vdc_check
  delegate_to: localhost
  failed_when: vdc_check.status not in [200, 201]

- name: Determinar si el Org VDC ya existe
  set_fact:
    vdc_exists: "{{ (vdc_check.json.record is defined) and (vdc_check.json.record | length > 0) }}"

- name: Mostrar estado del VDC
  debug:
    msg: "üí° Org VDC '{{ vcd.orgVdcName }}' {{ 'ya existe' if vdc_exists else 'no existe, se proceder√° a crear' }}."

- name: Crear organizaci√≥n en VMware Cloud Director v√≠a API cl√°sica
  ansible.builtin.uri:
    url: "{{ vcd.host }}/api/admin/orgs"
    method: POST
    headers:
      Accept: "application/*+xml;version={{ vcd.api_version | default('39.0') }}"
      x-vcloud-authorization: "{{ vcd.access_token }}"
      Content-Type: "application/vnd.vmware.admin.organization+xml"
    body: |
      <Org xmlns="http://www.vmware.com/vcloud/v1.5" name="{{ vcd.orgVdcName }}" fullName="{{ vcd.orgFullName }}" isEnabled="true">
        <Description>Organizaci√≥n creada v√≠a Ansible</Description>
        <StoredVmQuota>{{ vcd.storageQuota | default(10) }}</StoredVmQuota>
        <DeploymentLeaseSeconds>86400</DeploymentLeaseSeconds>
        <StorageLeaseSeconds>86400</StorageLeaseSeconds>
        <OrgSettings>
          <OrgGeneralSettings>
            <CanPublishCatalogs>true</CanPublishCatalogs>
            <DeployedVMQuota>{{ vcd.vmQuota | default(2) }}</DeployedVMQuota>
            <StoredVMQuota>{{ vcd.storageQuota | default(10) }}</StoredVMQuota>
          </OrgGeneralSettings>
        </OrgSettings>
      </Org>
    body_format: raw
    validate_certs: false
  register: org_create
  delegate_to: localhost
  failed_when: org_create.status not in [200, 201, 202]

- name: Confirmar creaci√≥n de la organizaci√≥n
  debug:
    msg: "üèóÔ∏è Organizaci√≥n '{{ vdc.orgVdcName }}' creada exitosamente v√≠a API cl√°sica."
