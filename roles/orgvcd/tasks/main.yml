# ===========================================================
# EXTRAER PREFIJO DEL ORG VDC
# ===========================================================
- name: Extraer prefijo del Org VDC
  set_fact:
    locationPrefix: "{{ vcd.orgVdcName.split('-')[0] }}"

# ===========================================================
# VALIDAR ORGANIZACIÓN EXISTENTE
# ===========================================================
- name: Obtener ID de la organización
  uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/orgs?filter=name=={{ vcd.orgFullName }}"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: org_check

- name: Extraer ID de la organización
  set_fact:
    org_id: "{{ org_check.json['values'][0].id if (org_check.json['values'] | length > 0) else '' }}"

- name: Validar existencia de la organización
  fail:
    msg: "❌ La organización '{{ vcd.orgFullName }}' no existe. Debe ser creada previamente."
  when: org_id == ''

# ===========================================================
# RESOLVER COMPONENTES NECESARIOS
# ===========================================================
- name: Obtener todos los Provider VDCs
  uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/providerVdcs"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: provider_check

- name: Obtener todos los Network Pools
  uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/networkPools/networkPoolSummaries"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: network_check

- name: Obtener todos los Storage Profiles
  uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/providerVdcs"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: storage_check

- name: Buscar Provider VDC por prefijo
  set_fact:
    provider_match: >-
      {{
        provider_check.json['values'] |
        selectattr('name', 'search', '^' ~ locationPrefix) |
        list |
        first
      }}
  when: provider_check.json['values'] | length > 0

- name: Extraer ID del Provider VDC
  set_fact:
    provider_id: "{{ provider_match.id }}"
  when: provider_match is defined

- name: Buscar Network Pool por prefijo
  set_fact:
    network_match: >-
      {{
        network_check.json['values'] |
        selectattr('name', 'search', '^' ~ locationPrefix) |
        list |
        first
      }}
  when: network_check.json['values'] | length > 0

- name: Extraer ID del Network VDC
  set_fact:
    network_id: "{{ network_match.id }}"
  when: network_match is defined

- name: Buscar Storage Profile por nombre
  set_fact:
    storage_match: >-
      {{
        storage_check.json['values'] |
        selectattr('name', 'search', '^' ~ locationPrefix) |
        list |
        first
      }}
  when: storage_check.json['values'] | length > 0

- name: Extraer ID del Storage VDC
  set_fact:
    storage_id: "{{ storage_match.id }}"
  when: storage_match is defined

- name: Validar Provider VDC encontrado
  fail:
    msg: "❌ No se encontró ningún Provider VDC que comience con '{{ locationPrefix }}'."
  when: provider_id is not defined

- name: Validar Network Pool encontrado
  fail:
    msg: "❌ No se encontró ningún Network Pool que comience con '{{ locationPrefix }}'."
  when: network_id is not defined

- name: Validar Storage Profile encontrado
  fail:
    msg: "❌ No se encontró Storage Profile con nombre '{{ vcd.storageProfileName }}'."
  when: storage_id is not defined

- name: Extraer UUID desde el orgId
  set_fact:
    org_uuid: "{{ org_id.split(':')[-1] }}"

# ===========================================================
# VALIDAR EXISTENCIA DEL ORG VDC
# ===========================================================
- name: Verificar si el Org VDC ya existe por nombre
  uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/vdcs?filter=name=={{ vcd.orgVdcName }}"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: vdc_check

- name: Determinar si el Org VDC ya existe
  set_fact:
    vdc_exists: "{{ vdc_check.json['values'] | length > 0 }}"

# ===========================================================
# CREAR ORG VDC
# ===========================================================
- name: Crear Org VDC vía CloudAPI
  when: not vdc_exists
  uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/orgs/{{ vcd.orgVdcName }}/vdcs"
    method: POST
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ vcd.orgVdcName }}"
      description: "Automatically created organization vdc {{ vcd.orgVdcName }}"
      isEnabled: true
      allocationModel: "{{ allocationModel }}"
      computeCapacity:
        cpu:
          units: "MHz"
          allocated: "{{ (vcd.cpuQuota | float * 1000) | int }}"
          limit: "{{ (vcd.cpuQuota | float * 1000) | int }}"
        memory:
          units: "MB"
          allocated: "{{ (vcd.memoryQuota | float * 1024) | int }}"
          limit: "{{ (vcd.memoryQuota | float * 1024) | int }}"
      providerVdc:
        id: "{{ provider_id }}"
      networkPool:
        id: "{{ network_id }}"
      storageProfiles:
        - id: "{{ storage_id }}"
          limit: "{{ (vcd.storageQuota | float * 1024) | int }}"
      isThinProvision: "{{ isThinProvision }}"
      usesFastProvisioning: "{{ usesFastProvisioning }}"
      networkQuota: "{{ vcd.networkQuota }}"
      vCpuInMhz: "{{ vCpuInMhz }}"
    validate_certs: false
  register: vdc_create

- name: Confirmar creación del Org VDC
  when: not vdc_exists
  debug:
    msg: "✅ Org VDC '{{ vcd.orgVdcName }}' creado exitosamente con ID '{{ vdc_create.json.id }}'."
