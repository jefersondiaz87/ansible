---
# ===========================================================
# VALIDAR SI EL ORG VDC YA EXISTE
# ===========================================================
- name: Verificar si el Org VDC ya existe en VMware Cloud Director
  uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/orgVdcs?filter=name=={{ vcd.orgVdcName }}"
    method: GET
    headers:
      Accept: "application/*+json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: vdc_check
  delegate_to: localhost
  failed_when: vdc_check.status not in [200, 201]

- name: Determinar si el Org VDC ya existe
  set_fact:
    vdc_exists: "{{ (vdc_check.json.record is defined) and (vdc_check.json.record | length > 0) }}"

- name: Mostrar estado del VDC
  debug:
    msg: "ðŸ’¡ Org VDC '{{ vcd.orgVdcName }}' {{ 'ya existe' if vdc_exists else 'no existe, se procederÃ¡ a crear' }}."

# ===========================================================
# CREAR ORG VDC (usando CloudAPI)
# ===========================================================

- name: Crear Org VDC en VMware Cloud Director vÃ­a CloudAPI
  when: not vdc_exists
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/orgVdcs"
    method: POST
    headers:
      Accept: "application/json;version={{ vcd.api_version | default('39.0') }}"
      Authorization: "Bearer {{ vcd.access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ vcd.orgVdcName }}"
      organization:
        name: "{{ vcd.orgFullName }}"
      providerVdc:
        name: "{{ providerVdc | default('ProviderVDC-Default') }}"
      allocationModel: "ReservationPool"
      computeCapacity:
        cpu:
          allocated: "{{ vcd.cpuQuota | int }}"
          limit: "{{ vcd.cpuQuota | int }}"
        memory:
          allocated: "{{ vcd.memoryQuota | int }}"
          limit: "{{ vcd.memoryQuota | int }}"
      storageProfiles:
        - name: "{{ storageProfile | default('Standard') }}"
          limit: "{{ vcd.storageQuota | int }}"
      networkPool:
        name: "{{ networkPool | default('Default-NetworkPool') }}"
      isEnabled: true
      usesFastProvisioning: true
    validate_certs: false
  register: vdc_create
  delegate_to: localhost
  failed_when: vdc_create.status not in [200, 201, 202]

- name: Confirmar creaciÃ³n del Org VDC
  when: not vdc_exists
  debug:
    msg: "âœ… Org VDC '{{ vcd.orgVdcName }}' creado exitosamente vÃ­a CloudAPI."

# ===========================================================
# AGREGAR / ACTUALIZAR METADATA (CloudAPI)
# ===========================================================

- name: Asignar metadata TrialMode al Org VDC
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/orgVdcs/{{ vdc_create.json.id }}/metadata"
    method: PUT
    headers:
      Accept: "application/json;version={{ vcd.api_version | default('39.0') }}"
      Authorization: "Bearer {{ vcd.access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      metadata:
        - key: "TrialMode"
          value: "{{ 'true' if trial else 'false' }}"
          type: "STRING"
    validate_certs: false
  register: metadata_update
  delegate_to: localhost
  failed_when: metadata_update.status not in [200, 201, 202]

- name: Confirmar metadata aplicada
  debug:
    msg: "ðŸŸ¢ Metadata 'TrialMode={{ 'true' if trial else 'false' }}' aplicada correctamente al Org VDC '{{ vcd.orgVdcName }}'."
