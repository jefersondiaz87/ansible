---
# playbook: create_org_and_admin.yml
# Crea una Organization y un usuario administrador en VMware Cloud Director usando Cloud API

- name: "‚úÖ Crear organizaci√≥n en VMware Cloud Director"
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/orgs"
    method: POST
    headers:
      x-vcloud-authorization: "{{ vcd.access_token }}"
      Content-Type: "application/json"
      Accept: "application/json;version={{ vcd.api_version }}"
    body_format: json
    body:
      name: "{{ vcd.orgFullName }}"
      displayName: "{{ vcd.orgFullName }}"
      description: "Organizaci√≥n creada v√≠a API"
    status_code: [201, 409] # 409 = ya existe
    validate_certs: "{{ vcd.verify_ssl }}"
  register: org_create
  ignore_errors: yes

- name: "‚ÑπÔ∏è Verificar si la organizaci√≥n ya existe"
  set_fact:
    org_exists: "{{ org_create.status == 409 }}"

- name: "üîπ Mostrar resultado de la creaci√≥n de la organizaci√≥n"
  debug:
    msg: >
      {% if org_exists %}
        ‚ö†Ô∏è La organizaci√≥n '{{ vcd.orgFullName }}' ya existe
      {% else %}
        ‚úÖ Organizaci√≥n '{{ vcd.orgFullName }}' creada correctamente
      {% endif %}

- name: "‚úÖ Crear usuario administrador en la organizaci√≥n"
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/orgs/{{ org_create.json.id }}/users"
    method: POST
    headers:
      x-vcloud-authorization: "{{ vcd.access_token }}"
      Content-Type: "application/json"
      Accept: "application/json;version={{ vcd.api_version }}"
    body_format: json
    body:
      name: "admin_{{ vcd.orgFullName | lower | replace(' ', '_') }}"
      password: "{{ vcd.adminPassword }}"
      description: "Usuario admin de la organizaci√≥n"
      role: "organizationAdmin"
      email: "{{ vcd.mail }}"
      enabled: true
    status_code: [201, 409] # 409 = ya existe
    validate_certs: "{{ vcd.verify_ssl }}"
  register: admin_create
  ignore_errors: yes

- name: "‚ÑπÔ∏è Verificar si el usuario admin ya existe"
  set_fact:
    admin_exists: "{{ admin_create.status == 409 }}"

- name: "üîπ Mostrar resultado del usuario admin"
  debug:
    msg: >
      {% if admin_exists %}
        ‚ö†Ô∏è El usuario admin ya existe en '{{ vcd.orgFullName }}'
      {% else %}
        ‚úÖ Usuario admin creado correctamente en '{{ vcd.orgFullName }}'
      {% endif %}
