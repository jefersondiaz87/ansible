---
# tasks/main.yml - Rol: organization
# Crea una Organization en VMware Cloud Director usando Cloud API y token OAuth

- name: "‚úÖ Crear organizaci√≥n en VMware Cloud Director"
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/orgs"
    method: POST
    headers:
      x-vcloud-authorization: "{{ vcd.access_token }}"
      Content-Type: "application/json"
      Accept: "application/*+json;version={{api_version}}"
    body_format: json
    body:
      name: "{{ vcd.orgFullName }}"
      fullName: "{{ vcd.orgFullName }}"
      description: "Organizaci√≥n creada v√≠a API"
      settings:
        loginBanner: "Bienvenido a {{ vcd.orgFullName }}"
      owner:
        userName: "admin_{{ vcd.orgFullName | lower | replace(' ', '_') }}"
        fullName: "{{ vcd.firstName }} {{ vcd.lastName }}"
        email: "{{ vcd.mail }}"
        role: "organizationAdmin"
        enabled: true
    status_code: [201, 409] # 409 = ya existe
    validate_certs: "{{ vcd.verify_ssl | default(false) }}"
  register: org_create
  ignore_errors: yes

- name: "‚ÑπÔ∏è Verificar si la organizaci√≥n ya existe"
  set_fact:
    org_exists: "{{ org_create.status == 409 }}"

- name: "üîπ Mostrar resultado"
  debug:
    msg: >
      {% if org_exists %}
        ‚ö†Ô∏è La organizaci√≥n '{{ vcd.orgFullName }}' ya existe
      {% else %}
        ‚úÖ Organizaci√≥n '{{ vcd.orgFullName }}' creada correctamente
      {% endif %}
