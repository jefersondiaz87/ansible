---
# ============================================
# PLAYBOOK: CREAR / ELIMINAR ORG Y AGREGAR METADATA
# ============================================

- name: Gestionar organizaci√≥n en VMware Cloud Director
  hosts: localhost
  gather_facts: no
  vars:
    # Ejemplo de variables (pueden provenir de AWX credentials)
    # vcd.host: "https://vcd.example.com"
    # vcd.access_token: "{{ lookup('env','VCD_ACCESS_TOKEN') }}"
    # vcd.api_version: "39.1"
    # vcd.orgFullName: "US1001735"
    # trial: true
    # cleanup: false
    # vcd.verify_ssl_certs: false

  tasks:
    # =======================================
    # 1Ô∏è‚É£ VERIFICAR SI LA ORGANIZACI√ìN YA EXISTE
    # =======================================
    - name: Obtener lista de organizaciones
      ansible.builtin.uri:
        url: "{{ vcd.host }}/cloudapi/1.0.0/orgs"
        method: GET
        headers:
          x-vcloud-authorization: "{{ vcd.access_token }}"
          Accept: "application/json;version={{ vcd.api_version }}"
        validate_certs: "{{ vcd.verify_ssl | default(false) }}"
      register: org_list

    - name: Determinar si la organizaci√≥n ya existe
      set_fact:
        org_exists: "{{ org_list.json.value | selectattr('name','equalto', vcd.orgFullName) | list | length > 0 }}"

    # =======================================
    # 2Ô∏è‚É£ CREAR ORGANIZACI√ìN SI NO EXISTE
    # =======================================
    - name: Crear organizaci√≥n en VMware Cloud Director v√≠a REST
      ansible.builtin.uri:
        url: "{{ vcd.host }}/cloudapi/1.0.0/orgs"
        method: POST
        headers:
          x-vcloud-authorization: "{{ vcd.access_token }}"
          Accept: "application/json;version={{ vcd.api_version }}"
          Content-Type: "application/json"
        body_format: json
        body:
          displayName: "{{ vcd.orgFullName }}"
          name: "{{ vcd.orgFullName }}"
        status_code: [201, 200]
        validate_certs: "{{ vcd.verify_ssl | default(false) }}"
      register: org_create
      when: not org_exists

    - name: Mostrar resultado de la creaci√≥n
      debug:
        msg: >
          {% if org_exists %}
            ‚ö†Ô∏è La organizaci√≥n '{{ vcd.orgFullName }}' ya existe
          {% else %}
            ‚úÖ Organizaci√≥n creada: {{ org_create.json.name }}
          {% endif %}

    # =======================================
    # 3Ô∏è‚É£ AGREGAR METADATA TRIALMODE
    # =======================================
    - name: Agregar metadata TrialMode si trial=true
      ansible.builtin.uri:
        url: "{{ vcd.host }}/api/org/{{ vcd.orgFullName }}/metadata"
        method: POST
        headers:
          x-vcloud-authorization: "{{ vcd.access_token }}"
          Accept: "application/*+json;version={{ vcd.api_version }}"
          Content-Type: "application/vnd.vmware.vcloud.metadata+xml"
        body: |
          <Metadata xmlns="http://www.vmware.com/vcloud/v1.5" type="application/vnd.vmware.vcloud.metadata+xml">
            <MetadataEntry>
              <Key>TrialMode</Key>
              <Value>true</Value>
              <Type>STRING</Type>
            </MetadataEntry>
          </Metadata>
        status_code: [200, 201]
        validate_certs: "{{ vcd.verify_ssl | default(false) }}"
      register: metadata_set
      when: trial | bool

    - name: Mostrar metadata agregada
      debug:
        msg: "üè∑Ô∏è Metadata TrialMode agregada a {{ vcd.orgFullName }}"
      when: trial | bool

    # =======================================
    # 4Ô∏è‚É£ ELIMINAR ORGANIZACI√ìN SI cleanup=true
    # =======================================
    - name: Eliminar organizaci√≥n si cleanup=true
      ansible.builtin.uri:
        url: "{{ vcd.host }}/cloudapi/1.0.0/orgs/{{ vcd.orgFullName }}"
        method: DELETE
        headers:
          x-vcloud-authorization: "{{ vcd.access_token }}"
          Accept: "application/json"
        status_code: [202, 204, 404]
        validate_certs: "{{ vcd.verify_ssl | default(false) }}"
      register: org_delete
      when: cleanup | default(false) | bool

    - name: Mostrar resultado de eliminaci√≥n
      debug:
        msg: "üóëÔ∏è Organizaci√≥n {{ vcd.orgFullName }} eliminada (cleanup activado)"
      when: cleanup | default(false) | bool
