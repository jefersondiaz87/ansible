---
# ===============================
# CREAR / ELIMINAR ORGANIZACI√ìN (REST)
# ===============================

- name: Crear organizaci√≥n en VMware Cloud Director v√≠a REST
  ansible.builtin.uri:
    url: "{{ vcd_hostname }}/cloudapi/1.0.0/orgs"
    method: POST
    headers:
      x-vcloud-authorization: "{{ vcd_access_token }}"
      Accept: "application/json"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ orgFullName }}"
      displayName: "{{ orgFullName }}"
      isEnabled: true
    status_code: [201, 200]
    validate_certs: "{{ vcd_verify_ssl_certs | default(false) }}"
  register: org_create

- debug:
    msg: "‚úÖ Organizaci√≥n creada: {{ org_create.json.name }}"

# =======================================
# AGREGAR METADATA A LA ORGANIZACI√ìN
# =======================================

- name: Agregar metadata TrialMode si trial=true
  when: trial | bool
  ansible.builtin.uri:
    url: "{{ vcd_hostname }}/api/org/{{ orgFullName }}/metadata"
    method: POST
    headers:
      x-vcloud-authorization: "{{ vcd_access_token }}"
      Accept: "application/*+json;version={{ vcd_api_version }}"
      Content-Type: "application/vnd.vmware.vcloud.metadata+xml"
    body: |
      <Metadata xmlns="http://www.vmware.com/vcloud/v1.5" type="application/vnd.vmware.vcloud.metadata+xml">
        <MetadataEntry>
          <Key>TrialMode</Key>
          <Value>true</Value>
          <Type>STRING</Type>
        </MetadataEntry>
      </Metadata>
    status_code: [200, 201]
    validate_certs: "{{ vcd_verify_ssl_certs | default(false) }}"
  register: metadata_set

- debug:
    msg: "üè∑Ô∏è Metadata TrialMode agregada a {{ orgFullName }}"
  when: trial | bool

# =======================================
# (Opcional) ELIMINAR ORGANIZACI√ìN
# =======================================
- name: Eliminar organizaci√≥n si cleanup=true
  when: cleanup | default(false) | bool
  ansible.builtin.uri:
    url: "{{ vcd_hostname }}/cloudapi/1.0.0/orgs/{{ orgFullName }}"
    method: DELETE
    headers:
      x-vcloud-authorization: "{{ vcd_access_token }}"
      Accept: "application/json"
    status_code: [202, 204, 404]
    validate_certs: "{{ vcd_verify_ssl_certs | default(false) }}"
  register: org_delete

- debug:
    msg: "üóëÔ∏è Organizaci√≥n {{ orgFullName }} eliminada (cleanup activado)"
  when: cleanup | default(false) | bool
