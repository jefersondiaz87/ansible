---
# tasks/main.yml - Rol: organization
# Crea una Organization en VMware Cloud Director usando Cloud API y token OAuth

- name: "‚úÖ Crear organizaci√≥n en VMware Cloud Director"
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/orgs"
    method: POST
    headers:
      x-vcloud-authorization: "{{ vcd.access_token }}"
      Content-Type: "application/json"
      Accept: "application/json;version={{ vcd.api_version }}"
    body_format: json
    body:
      name: "{{ vcd.orgFullName }}"
      displayName: "{{ vcd.orgFullName }}"
      description: "Organizaci√≥n creada v√≠a API"

    status_code: [201, 409] # 409 = ya existe
    validate_certs: "{{ vcd.verify_ssl | default(false) }}"
  register: org_create
  ignore_errors: yes

- name: "‚ÑπÔ∏è Verificar si la organizaci√≥n ya existe"
  set_fact:
    org_exists: "{{ org_create.status == 409 }}"

- name: "üîπ Mostrar resultado"
  debug:
    msg: >
      {% if org_exists %}
        ‚ö†Ô∏è La organizacion '{{ vcd.orgFullName }}' ya existe
      {% else %}
        ‚úÖ Organizacion '{{ vcd.orgFullName }}' creada correctamente
      {% endif %}
