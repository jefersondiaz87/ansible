---
# playbook: create_org_and_admin.yml
# Crea una Organization y un usuario administrador en VMware Cloud Director usando CloudAPI directamente

- name: "âœ… Crear organizaciÃ³n en VMware Cloud Director (CloudAPI)"
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/orgs"
    method: POST
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ vcd.orgFullName }}"
      displayName: "{{ vcd.orgFullName }}"
      isEnabled: true
      description: "OrganizaciÃ³n creada automÃ¡ticamente por Ansible"
    status_code: [200, 201, 409] # 409 si ya existe
    validate_certs: "{{ vcd.verify_ssl }}"
  register: org_create
  changed_when: org_create.status == 201
  failed_when:
    - org_create.status not in [200, 201, 409]

- name: "ğŸ” Mostrar resultado de creaciÃ³n de la organizaciÃ³n"
  debug:
    msg: >
      {% if org_create.status == 201 %}
        âœ… OrganizaciÃ³n '{{ vcd.orgFullName }}' creada correctamente.
      {% elif org_create.status == 409 %}
        âš ï¸ La organizaciÃ³n '{{ vcd.orgFullName }}' ya existe.
      {% else %}
        âŒ Error al crear la organizaciÃ³n: {{ org_create }}
      {% endif %}

# Extrae el ID de la organizaciÃ³n creada o existente
- name: "ğŸ§© Guardar ID de la organizaciÃ³n creada"
  set_fact:
    org_id: "{{ (org_create.json.id | default('')) | regex_replace('^urn:vcloud:org:', '') }}"
  when: org_create.json is defined

- name: "âœ… Crear usuario administrador en la organizaciÃ³n"
  when: org_create.status in [200, 201, 409]
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/orgs/{{ org_create.json.id }}/users"
    method: POST
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "admin_{{ vcd.orgFullName | lower | replace(' ', '_') }}"
      password: "{{ vcd.adminPassword }}"
      description: "Usuario administrador de la organizaciÃ³n"
      role: "Organization Administrator"
      email: "{{ vcd.mail }}"
      enabled: true
    status_code: [201, 409]
    validate_certs: "{{ vcd.verify_ssl }}"
  register: admin_create
  ignore_errors: yes

- name: "ğŸ”¹ Mostrar resultado del usuario admin"
  debug:
    msg: >
      {% if admin_create.status == 201 %}
        âœ… Usuario administrador creado correctamente en '{{ vcd.orgFullName }}'.
      {% elif admin_create.status == 409 %}
        âš ï¸ El usuario administrador ya existe en '{{ vcd.orgFullName }}'.
      {% else %}
        âŒ Error al crear usuario admin: {{ admin_create }}
      {% endif %}
