---
# ===========================================================
# CREAR EDGE GATEWAY EN VCD (REST)
# ===========================================================

# -----------------------------------------------------------
# Construir el nombre del Edge Gateway igual que en vRO
# -----------------------------------------------------------
- name: Construir nombre del Edge Gateway
  ansible.builtin.set_fact:
    locationPrefix: "{{ orgVdcName.split('-')[0] }}"
    edgeGatewayName: "{{ locationPrefix }}-{{ orgFullName }}-{{ networkType }}"
  delegate_to: localhost

- name: Mostrar nombre calculado del Edge Gateway
  ansible.builtin.debug:
    msg: "ðŸ“¡ Edge Gateway generado: {{ edgeGatewayName }}"

# ===========================================================
# VALIDAR SI EL EDGE GATEWAY YA EXISTE
# ===========================================================
- name: Validar si el Edge Gateway ya existe
  ansible.builtin.uri:
    url: "{{ vcd_host }}/api/query?type=edgeGateway&filter=name=={{ edgeGatewayName }}"
    method: GET
    headers:
      Accept: "application/*+json;version={{ vcd_api_version }}"
      Authorization: "Bearer {{ vcd_token }}"
    return_content: yes
  register: edge_check
  delegate_to: localhost
  failed_when: edge_check.status not in [200, 201]

- name: Determinar si el Edge Gateway ya existe
  ansible.builtin.set_fact:
    edge_exists: "{{ (edge_check.json.record is defined) and (edge_check.json.record | length > 0) }}"

- name: Mostrar estado del Edge Gateway
  ansible.builtin.debug:
    msg: "ðŸ’¡ Edge Gateway '{{ edgeGatewayName }}' {{ 'ya existe' if edge_exists else 'no existe, se procederÃ¡ a crear' }}."

# ===========================================================
# CREAR EDGE GATEWAY SI NO EXISTE
# ===========================================================
- name: Crear Edge Gateway en VMware Cloud Director vÃ­a REST
  when: not edge_exists
  ansible.builtin.uri:
    url: "{{ vcd_host }}/api/orgVdc/{{ orgVdcName }}/edgeGateways"
    method: POST
    headers:
      Accept: "application/*+json;version={{ vcd_api_version }}"
      Authorization: "Bearer {{ vcd_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ edgeGatewayName }}"
      description: "Edge Gateway creado automÃ¡ticamente por Ansible REST"
      configuration:
        gatewayBackingConfig: "compact"
        distributedRoutingEnabled: false
        haEnabled: false
        edgeGatewayUplinks:
          - uplink:
              name: "{{ externalNetwork | default('External-Network') }}"
            subnets:
              values:
                - gateway: "{{ edge_gateway_ip | default('192.168.1.1') }}"
                  prefixLength: 24
      ownerRef:
        name: "{{ orgVdcName }}"
        type: "application/vnd.vmware.vcloud.vdc+xml"
        id: "urn:vcloud:vdc:{{ orgVdcName }}"
  register: edge_create
  delegate_to: localhost
  failed_when: edge_create.status not in [200, 201, 202]

- name: Confirmar creaciÃ³n del Edge Gateway
  when: not edge_exists
  ansible.builtin.debug:
    msg: "âœ… Edge Gateway '{{ edgeGatewayName }}' creado correctamente."

# ===========================================================
# AGREGAR METADATA TRIALMODE (OPCIONAL)
# ===========================================================
- name: Asignar metadata TrialMode al Edge Gateway
  ansible.builtin.uri:
    url: "{{ vcd_host }}/api/edgeGateway/{{ edgeGatewayName }}/metadata"
    method: PUT
    headers:
      Accept: "application/*+json;version={{ vcd_api_version }}"
      Authorization: "Bearer {{ vcd_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      metadata:
        - key: "TrialMode"
          value: "{{ 'true' if trial else 'false' }}"
          type: "STRING"
  register: metadata_update
  delegate_to: localhost
  failed_when: metadata_update.status not in [200, 201, 202]

- name: Confirmar metadata aplicada
  ansible.builtin.debug:
    msg: "ðŸŸ¢ Metadata 'TrialMode={{ 'true' if trial else 'false' }}' aplicada correctamente al Edge Gateway '{{ edgeGatewayName }}'."
