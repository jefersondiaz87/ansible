# -----------------------------------------------------------
# Construir el nombre del Edge Gateway igual que en vRO
# -----------------------------------------------------------
- name: Construir nombre del Edge Gateway
  ansible.builtin.set_fact:
    locationPrefix: "{{ vcd.orgVdcName.split('-')[0] }}"
    edgeGatewayName: "{{ vcd.orgVdcName.split('-')[0] }}-{{ vcd.orgFullName }}-{{ vcd.networkType }}"
    externalNetworkName: "{{ vcd.orgVdcName.split('-')[0] }}-{{ vcd.networkType }}-01"
  delegate_to: localhost

- name: Mostrar nombre calculado del Edge Gateway
  ansible.builtin.debug:
    msg:
      - "ðŸ“ locationPrefix: {{ locationPrefix }}"
      - "ðŸ“¡ Edge Gateway generado: {{ edgeGatewayName }}"
      - "ðŸŒ External Network esperada: {{ externalNetworkName }}"

# ===========================================================
# VALIDAR SI EL EDGE GATEWAY YA EXISTE (USANDO CLOUDAPI)
# ===========================================================
- name: Validar si el Edge Gateway ya existe (CloudAPI)
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/edgeGateways?filter=name=={{ edgeGatewayName }}"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    validate_certs: "{{ vcd.verify_ssl }}"
    return_content: yes
  register: edge_check
  delegate_to: localhost
  failed_when: edge_check.status not in [200, 201]

- name: Determinar si el Edge Gateway ya existe
  ansible.builtin.set_fact:
    edge_exists: "{{ ('values' in edge_check.json) and (edge_check.json['values'] | length > 0) }}"

- name: Mostrar estado del Edge Gateway
  ansible.builtin.debug:
    msg:
      - "ðŸ’¡ Edge Gateway buscado: {{ edgeGatewayName }}"
      - "ðŸ“‹ Resultado CloudAPI: {{ (edge_check.json['values'] | length) if ('values' in edge_check.json) else 0 }} encontrados"
      - "ðŸ” Estado: {{ 'YA EXISTE âœ…' if edge_exists else 'NO EXISTE ðŸš€ Se procederÃ¡ a crear' }}"

# ===========================================================
# OBTENER ID DE LA RED EXTERNA SEGÃšN locationPrefix Y networkType
# ===========================================================
- name: Buscar red externa por nombre
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/externalNetworks?filter=name=={{ externalNetworkName }}"
    method: GET
    headers:
      Authorization: "Bearer {{ vcd.access_token }}"
      Accept: "application/json;version={{ vcd.api_version }}"
    validate_certs: "{{ vcd.verify_ssl }}"
  register: ext_net_lookup

- name: Validar que exista red externa
  ansible.builtin.fail:
    msg: "âŒ No se encontrÃ³ red externa con nombre '{{ externalNetworkName }}'"
  when: ('values' not in ext_net_lookup.json) or (ext_net_lookup.json['values'] | length == 0)

- name: Guardar ID de la red externa
  ansible.builtin.set_fact:
    extNetId: "{{ ext_net_lookup.json['values'][0].id }}"

- name: Mostrar red externa seleccionada
  ansible.builtin.debug:
    msg: "ðŸŒ Red externa seleccionada: {{ externalNetworkName }} (ID: {{ extNetId }})"

# ===========================================================
# CREAR EDGE GATEWAY SI NO EXISTE
# ===========================================================
- name: Crear Edge Gateway en VMware Cloud Director vÃ­a CloudAPI
  when: not edge_exists
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/edgeGateways"
    method: POST
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ edgeGatewayName }}"
      description: "Edge Gateway creado automÃ¡ticamente por Ansible REST"
      orgVdc:
        id: "{{ vcd.orgVdcName }}"
      externalNetwork:
        id: "{{ extNetId }}"
      edgeGatewayType: "{{ vcd.networkType }}"
      haEnabled: false
      distributedRoutingEnabled: false
      advancedNetworkingEnabled: true
  register: edge_create
  delegate_to: localhost
  failed_when: edge_create.status not in [200, 201, 202]

- name: Confirmar creaciÃ³n del Edge Gateway
  when: not edge_exists
  ansible.builtin.debug:
    msg: "âœ… Edge Gateway '{{ edgeGatewayName }}' creado correctamente."

# ===========================================================
# OBTENER URN DEL EDGE GATEWAY
# ===========================================================
- name: Obtener URN del Edge Gateway
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/edgeGateways?filter=name=={{ edgeGatewayName }}"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
  register: edge_query

- name: Guardar URN del Edge Gateway
  ansible.builtin.set_fact:
    edge_urn: "{{ edge_query.json['values'][0].id if ('values' in edge_query.json and edge_query.json['values'] | length > 0) else '' }}"

# ===========================================================
# AGREGAR METADATA TRIALMODE (OPCIONAL)
# ===========================================================
- name: Asignar metadata TrialMode al Edge Gateway
  when: edge_urn != ''
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/entities/{{ edge_urn }}/metadata"
    method: POST
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      key: "TrialMode"
      value: "{{ trial | string | lower }}"
      type: "STRING"
  register: metadata_update
  delegate_to: localhost
  failed_when: metadata_update.status not in [200, 201, 202]

- name: Confirmar metadata aplicada
  when: edge_urn != ''
  ansible.builtin.debug:
    msg: "ðŸŸ¢ Metadata 'TrialMode={{ 'true' if trial else 'false' }}' aplicada correctamente al Edge Gateway '{{ edgeGatewayName }}'."
